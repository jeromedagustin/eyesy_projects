<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EYESY Web - Pyodide</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #fff;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #2a2a2a;
            padding: 1rem;
            border-bottom: 1px solid #3a3a3a;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .loading-status {
            font-size: 0.9rem;
            color: #aaa;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            position: relative;
        }

        #canvas {
            max-width: 100%;
            max-height: 100%;
            background: #000;
        }

        .controls-container {
            width: 300px;
            background: #2a2a2a;
            border-left: 1px solid #3a3a3a;
            overflow-y: auto;
        }

        .controls-panel {
            padding: 1rem;
        }

        .controls-header h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        .knob-group {
            margin-bottom: 1.5rem;
        }

        .knob-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #ccc;
        }

        .knob-group input[type="range"] {
            width: 100%;
            height: 6px;
            background: #3a3a3a;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .knob-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #4a9eff;
            border-radius: 50%;
            cursor: pointer;
        }

        .knob-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #4a9eff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .button-group {
            margin-bottom: 1.5rem;
        }

        .trigger-button {
            width: 100%;
            padding: 0.75rem;
            background: #4a9eff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .trigger-button:hover {
            background: #5aaeff;
        }

        .trigger-button:active {
            background: #3a8eef;
        }

        .button-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #ccc;
        }

        .info-group {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #3a3a3a;
            font-size: 0.9rem;
            color: #aaa;
        }

        .info-group div {
            margin-bottom: 0.5rem;
        }

        .mode-selector {
            padding: 1rem;
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
        }

        .mode-selector select {
            width: 100%;
            padding: 0.5rem;
            background: #3a3a3a;
            color: #fff;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .error-message {
            background: #d32f2f;
            color: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>EYESY Web - Pyodide</h1>
        <div class="loading-status" id="loading-status">Initializing...</div>
    </div>

    <div class="error-message" id="error-message"></div>

    <div class="mode-selector">
        <select id="mode-select">
            <option value="">Select a mode...</option>
        </select>
    </div>

    <div class="main-content">
        <div class="canvas-container">
            <canvas id="canvas" width="1280" height="720"></canvas>
        </div>
        <div class="controls-container" id="controls-container"></div>
    </div>

    <!-- Load Pyodide from CDN -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    
    <!-- Load our modules -->
    <script src="js/pyodide-loader.js"></script>
    <script src="js/pygame-bridge.js"></script>
    <script src="js/eyesy-api.js"></script>
    <script src="js/mode-runner.js"></script>
    <script src="js/controls.js"></script>

    <script>
        // Main application
        let pyodideLoader, pygameBridge, eyesyAPI, modeRunner, controls;

        async function init() {
            try {
                updateStatus('Loading Pyodide...');

                // Initialize Pyodide
                pyodideLoader = new PyodideLoader();
                await pyodideLoader.load((progress) => {
                    updateStatus(progress.status);
                });

                updateStatus('Setting up pygame bridge...');

                // Initialize pygame bridge
                const canvas = document.getElementById('canvas');
                pygameBridge = new PygameBridge(canvas);
                await pygameBridge.initialize(pyodideLoader);

                updateStatus('Setting up EYESY API...');

                // Initialize EYESY API
                eyesyAPI = new EYESYAPI(canvas);
                eyesyAPI.injectIntoPyodide(pyodideLoader);

                updateStatus('Initializing mode runner...');

                // Initialize mode runner
                modeRunner = new ModeRunner(pyodideLoader, pygameBridge, eyesyAPI, canvas);

                updateStatus('Setting up controls...');

                // Initialize controls
                const controlsContainer = document.getElementById('controls-container');
                controls = new EYESYControls(eyesyAPI, modeRunner);
                controls.create(controlsContainer);

                updateStatus('Ready!');

                // Load available modes (even if there were minor initialization issues)
                await loadAvailableModes();

                // Set up mode selector
                const modeSelect = document.getElementById('mode-select');
                modeSelect.addEventListener('change', async (e) => {
                    const modePath = e.target.value;
                    if (modePath) {
                        await loadMode(modePath);
                    }
                });

            } catch (error) {
                showError(`Initialization failed: ${error.message}`);
                console.error('Initialization error:', error);
                
                // Still try to load modes even if initialization had issues
                try {
                    await loadAvailableModes();
                } catch (modeError) {
                    console.error('Failed to load modes:', modeError);
                }
            }
        }

        async function loadAvailableModes() {
            try {
                updateStatus('Loading mode list...');
                
                // Load mode manifest
                const response = await fetch('modes/manifest.json');
                if (!response.ok) {
                    throw new Error(`Failed to load manifest: ${response.status} ${response.statusText}`);
                }
                const manifest = await response.json();
                
                console.log(`Loaded manifest with ${manifest.modes.length} modes`);
                
                const modeSelect = document.getElementById('mode-select');
                
                // Group modes by category
                const categories = {};
                manifest.modes.forEach(mode => {
                    if (!categories[mode.category]) {
                        categories[mode.category] = [];
                    }
                    categories[mode.category].push(mode);
                });
                
                // Add modes grouped by category
                Object.keys(categories).sort().forEach(category => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = manifest.categories[category] || category;
                    
                    categories[category].forEach(mode => {
                        const option = document.createElement('option');
                        option.value = mode.path;
                        option.textContent = mode.name;
                        optgroup.appendChild(option);
                    });
                    
                    modeSelect.appendChild(optgroup);
                });
                
                updateStatus(`Loaded ${manifest.modes.length} modes`);
            } catch (error) {
                showError(`Failed to load modes: ${error.message}`);
                console.error('Error loading modes:', error);
                
                // Fallback to template mode
                const modeSelect = document.getElementById('mode-select');
                const option = document.createElement('option');
                option.value = 'modes/template-mode.py';
                option.textContent = 'Template Mode (fallback)';
                modeSelect.appendChild(option);
            }
        }

        async function loadMode(modePath) {
            try {
                updateStatus(`Loading mode: ${modePath}...`);
                
                // Extract mode name from path
                const modeName = modePath.split('/').pop().replace('.py', '').replace(/-/g, ' ');

                // Stop current mode if running
                if (modeRunner) {
                    modeRunner.stop();
                }

                // Load mode
                await modeRunner.loadModeFromFile(modePath, modeName);

                // Update controls
                if (controls) {
                    controls.updateModeDisplay(modeName);
                }

                // Start running
                modeRunner.start();

                updateStatus('Mode running!');
            } catch (error) {
                showError(`Failed to load mode: ${error.message}`);
                console.error('Mode loading error:', error);
            }
        }

        function updateStatus(message) {
            const statusEl = document.getElementById('loading-status');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.add('show');
                setTimeout(() => {
                    errorEl.classList.remove('show');
                }, 5000);
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>

